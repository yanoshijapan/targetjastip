<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Jastip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Modern Gradient Background */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
        }
        .bg-gradient-secondary {
            background: linear-gradient(135deg, #30354a 0%, #465275 100%);
        }

        /* Glassmorphism Card Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* Smooth Animation for Progress Bar */
        .progress-fill { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">

    <div class="bg-gradient-secondary text-white pb-24 rounded-b-[3rem] shadow-xl">
        <div class="max-w-5xl mx-auto px-6 pt-8 pb-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight"><i class="fa-solid fa-plane-up mr-2 text-red-400"></i>Pencapaian Jastip</h1>
                    <p class="text-gray-300 text-sm mt-1">Monitoring Pencapaian KG Jastip</p>
                </div>
                <div class="text-right">
                    <div class="text-xs bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm" id="update-badge">
                        <i class="fa-regular fa-clock mr-1"></i> <span id="lastUpdated">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 -mt-20 space-y-8">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass-card p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-20 h-20 bg-red-100 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition"></div>
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                    <span class="text-red-500">üáÆüá© ID</span> ‚ûù üáØüáµ JP
                </label>
                <select id="select-ij" class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl focus:ring-red-500 focus:border-red-500 block p-3 shadow-sm transition" onchange="fetchData('ij')">
                    <option selected disabled value="">Pilih Dari Sheet Spreadsheet...</option>
                </select>
            </div>

            <div class="glass-card p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-20 h-20 bg-blue-100 rounded-full -mr-10 -mt-10 opacity-50 group-hover:scale-110 transition"></div>
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                    <span class="text-blue-500">üáØüáµ JP</span> ‚ûù üáÆüá© ID
                </label>
                <select id="select-ji" class="w-full bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 shadow-sm transition" onchange="fetchData('ji')">
                    <option selected disabled value="">Pilih Dari Sheet Spreadsheet...</option>
                </select>
            </div>
        </div>

        <div id="wrapper-ij" class="hidden animate-fade-in-up">
            <div class="flex items-center gap-3 mb-4 pl-2">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600 shadow-sm">
                    <i class="fa-solid fa-earth-asia"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800 leading-tight">Jastip: Indo ke Jepang</h2>
                    <p class="text-xs text-gray-500">Target Max per Batch: <span class="font-bold text-gray-700">140 KG</span></p>
                </div>
            </div>
            <div id="grid-ij" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <div id="wrapper-ji" class="hidden animate-fade-in-up">
            <div class="flex items-center gap-3 mb-4 mt-8 pl-2">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm">
                    <i class="fa-solid fa-plane-arrival"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800 leading-tight">Jastip: Jepang ke Indo</h2>
                    <p class="text-xs text-gray-500">Target Max per Batch: <span class="font-bold text-gray-700">140 KG</span></p>
                </div>
            </div>
            <div id="grid-ji" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

    </div>

    <script>
        // === GANTI URL INI DENGAN DEPLOYMENT WEB APP BARU ANDA ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbx6rG-SFgfwh6_mARCnqtzBAL-7x3QPMtHdyYb1bg_SLy27cOQQF_8MpiWXOApVROyj/exec'; 
        const MAX_TARGET = 140; // Target statis 140 KG

        // Constants untuk LocalStorage keys
        const STORAGE_KEY_IJ = 'yanoshi_last_sheet_ij';
        const STORAGE_KEY_JI = 'yanoshi_last_sheet_ji';

        function formatNumber(num) {
            if (num === "" || num === null || isNaN(num)) return "0";
            let val = parseFloat(num);
            return val.toFixed(2); 
        }

        function getColorClass(percentage) {
            if (percentage >= 100) return 'bg-purple-600'; 
            if (percentage >= 85) return 'bg-red-500'; 
            if (percentage >= 50) return 'bg-amber-400'; 
            return 'bg-emerald-500'; 
        }

        function createCard(title, value, icon, delay, showProgress = false) {
            const numVal = parseFloat(value) || 0;
            const formattedVal = formatNumber(numVal);
            
            let bottomContent = '';

            if (showProgress) {
                const percentage = Math.min((numVal / MAX_TARGET) * 100, 100);
                const colorClass = getColorClass(percentage);
                
                bottomContent = `
                <div class="mt-4">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>${percentage.toFixed(0)}%</span>
                        <span>${MAX_TARGET}kg</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                        <div class="h-full rounded-full ${colorClass} progress-fill relative" style="width: 0%" data-width="${percentage}%">
                             <div class="absolute inset-0 bg-white opacity-20 w-full h-full animate-pulse"></div>
                        </div>
                    </div>
                </div>`;
            } else {
                bottomContent = `<div class="mt-4 h-2"></div>`;
            }

            return `
            <div class="glass-card p-4 rounded-xl flex flex-col justify-between h-full transform transition hover:-translate-y-1 hover:shadow-lg duration-300" style="animation: fadeIn 0.5s ease-out ${delay}s backwards;">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${title}</span>
                    <i class="${icon} text-gray-300 text-sm"></i>
                </div>
                
                <div class="mt-1">
                    <div class="flex items-baseline gap-1">
                        <span class="text-2xl font-bold text-gray-800 counter" data-target="${formattedVal}">0</span>
                        <span class="text-xs font-medium text-gray-500">KG</span>
                    </div>
                </div>

                ${bottomContent}
            </div>`;
        }

        async function loadSheets() {
            try {
                const res = await fetch(`${API_URL}?action=getSheetNames`);
                const json = await res.json();
                if (json.status === 'success') {
                    const opts = json.data.map(n => `<option value="${n}">${n}</option>`).join('');
                    
                    const selectIJ = document.getElementById('select-ij');
                    const selectJI = document.getElementById('select-ji');
                    
                    selectIJ.innerHTML += opts;
                    selectJI.innerHTML += opts;

                    // === FITUR BARU: AUTO RESTORE HISTORY ===
                    // Cek apakah ada data tersimpan di LocalStorage
                    const savedIJ = localStorage.getItem(STORAGE_KEY_IJ);
                    const savedJI = localStorage.getItem(STORAGE_KEY_JI);

                    // Jika ada dan valid (ada di dalam opsi), set value dan load data
                    if (savedIJ && selectIJ.querySelector(`option[value="${savedIJ}"]`)) {
                        selectIJ.value = savedIJ;
                        fetchData('ij'); // Load otomatis
                    }

                    if (savedJI && selectJI.querySelector(`option[value="${savedJI}"]`)) {
                        selectJI.value = savedJI;
                        fetchData('ji'); // Load otomatis
                    }
                }
            } catch(e) { console.error(e); }
        }

        async function fetchData(type) {
            const selectId = type === 'ij' ? 'select-ij' : 'select-ji';
            const select = document.getElementById(selectId);
            const wrapper = document.getElementById(type === 'ij' ? 'wrapper-ij' : 'wrapper-ji');
            const grid = document.getElementById(type === 'ij' ? 'grid-ij' : 'grid-ji');
            
            if(!select.value) return;

            // === FITUR BARU: SIMPAN HISTORY ===
            // Simpan pilihan user ke LocalStorage agar ingat saat direfresh
            const storageKey = type === 'ij' ? STORAGE_KEY_IJ : STORAGE_KEY_JI;
            localStorage.setItem(storageKey, select.value);

            // Loading State
            grid.innerHTML = '<div class="col-span-full py-8 text-center text-gray-400 animate-pulse">Mengambil data...</div>';
            wrapper.classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}?action=getData&sheetName=${encodeURIComponent(select.value)}`);
                const json = await res.json();
                
                if (json.status === 'success') {
                    const d = json.data;
                    
                    grid.innerHTML = `
                        ${createCard('Terpenuhi', d.kuota, 'fa-solid fa-box-open', 0, true)}
                        ${createCard('Sementara', d.sementara, 'fa-solid fa-scale-unbalanced', 0.1, false)}
                        ${createCard('Bagasi', d.bagasi, 'fa-solid fa-suitcase-rolling', 0.2, false)}
                        ${createCard('Kabin', d.kabin, 'fa-solid fa-briefcase', 0.3, false)}
                    `;

                    startAnimations(grid);
                    
                    const now = new Date();
                    document.getElementById('lastUpdated').innerText = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                }
            } catch (e) {
                grid.innerHTML = `<div class="text-red-500 text-sm p-4 col-span-full">Gagal memuat data. Periksa koneksi.</div>`;
            }
        }

        function startAnimations(container) {
            container.querySelectorAll('.counter').forEach(counter => {
                const target = parseFloat(counter.getAttribute('data-target'));
                const duration = 1500; 
                const start = performance.now();
                
                requestAnimationFrame(function animate(currentTime) {
                    let timeFraction = (currentTime - start) / duration;
                    if (timeFraction > 1) timeFraction = 1;
                    
                    const currentVal = (timeFraction * target).toFixed(2);
                    counter.innerText = currentVal; 

                    if (timeFraction < 1) requestAnimationFrame(animate);
                });
            });

            setTimeout(() => {
                const bars = container.querySelectorAll('.progress-fill');
                if (bars.length > 0) {
                    bars.forEach(bar => {
                        bar.style.width = bar.getAttribute('data-width');
                    });
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', loadSheets);

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
