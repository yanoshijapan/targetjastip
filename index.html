<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencapaian Jastip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Header Gradient */
        .header-bg {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        }

        /* Card Style */
        .grid-card {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .grid-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #cbd5e1;
        }

        /* Tab States */
        .tab-active {
            background-color: white;
            color: #0f172a;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-inactive {
            color: #94a3b8;
        }
        .tab-inactive:hover { color: #e2e8f0; }

        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Progress Bar Animation */
        .progress-fill { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="header-bg text-white pt-6 pb-24 rounded-b-[2rem] shadow-lg relative overflow-hidden">
        <div class="max-w-4xl mx-auto px-6 text-center relative z-10">
            <h1 class="text-xl font-bold tracking-tight">Pencapaian & Target Jastip</h1>
            <p class="text-slate-400 text-xs mt-1" id="last-update">Loading data...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 -mt-16 relative z-20">
        
        <div class="bg-slate-800/90 backdrop-blur p-1.5 rounded-xl flex justify-between items-center shadow-lg mb-4 border border-white/10">
            <button onclick="switchTab('ij')" id="tab-btn-ij" class="w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-active">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> Indo ➝ Jepang
            </button>
            <button onclick="switchTab('ji')" id="tab-btn-ji" class="w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-inactive">
                <span class="w-2 h-2 rounded-full bg-blue-500"></span> Jepang ➝ Indo
            </button>
        </div>

        <div class="relative mb-6 group">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
            </div>
            <input type="text" id="searchInput" onkeyup="filterGrid()" placeholder="Cari nama variabel..." 
                class="block w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm transition-all text-sm">
        </div>

        <div id="content-ij" class="fade-in">
            <div id="grid-ij" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="h-32 bg-white rounded-xl animate-pulse col-span-2 md:col-span-1"></div>
                <div class="h-32 bg-white rounded-xl animate-pulse col-span-2 md:col-span-1"></div>
            </div>
            <div id="empty-ij" class="hidden text-center py-10 text-slate-400 text-sm">
                <i class="fa-regular fa-folder-open text-2xl mb-2"></i><br>Variabel tidak ditemukan.
            </div>
        </div>

        <div id="content-ji" class="hidden">
            <div id="grid-ji" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                 <div class="h-32 bg-white rounded-xl animate-pulse col-span-2 md:col-span-1"></div>
            </div>
            <div id="empty-ji" class="hidden text-center py-10 text-slate-400 text-sm">
                <i class="fa-regular fa-folder-open text-2xl mb-2"></i><br>Variabel tidak ditemukan.
            </div>
        </div>

    </div>

    <script>
        // === GANTI URL API DI SINI ===
        const API_URL = 'https://script.google.com/macros/s/AKfycbzVpSR-SovszpbuMorHulaygazCD8sa-nzTDAN0AsmrjedHpNUwXoYScp4bGW36K-CP/exec'; 

        // --- FILTER / SEARCH FUNCTION (BARU) ---
        function filterGrid() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            
            // Tentukan Grid mana yang sedang aktif
            const isIJActive = !document.getElementById('content-ij').classList.contains('hidden');
            const activeGridId = isIJActive ? 'grid-ij' : 'grid-ji';
            const emptyStateId = isIJActive ? 'empty-ij' : 'empty-ji';
            
            const grid = document.getElementById(activeGridId);
            const cards = grid.getElementsByClassName('grid-card');
            const emptyMsg = document.getElementById(emptyStateId);
            
            let hasVisibleItem = false;

            // Loop semua kartu dan sembunyikan yang tidak cocok
            for (let i = 0; i < cards.length; i++) {
                const titleElement = cards[i].getElementsByTagName("h3")[0];
                if (titleElement) {
                    const txtValue = titleElement.textContent || titleElement.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        cards[i].style.display = "";
                        hasVisibleItem = true;
                    } else {
                        cards[i].style.display = "none";
                    }
                }
            }

            // Tampilkan pesan jika tidak ada hasil
            if (!hasVisibleItem) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
            }
        }

        // --- TAB LOGIC ---
        function switchTab(tabName) {
            const contentIJ = document.getElementById('content-ij');
            const contentJI = document.getElementById('content-ji');
            const btnIJ = document.getElementById('tab-btn-ij');
            const btnJI = document.getElementById('tab-btn-ji');
            const searchInput = document.getElementById('searchInput');

            // Reset Pencarian saat ganti tab
            searchInput.value = '';
            
            // Reset visibility semua kartu di kedua grid
            const allCards = document.querySelectorAll('.grid-card');
            allCards.forEach(card => card.style.display = "");
            document.getElementById('empty-ij').classList.add('hidden');
            document.getElementById('empty-ji').classList.add('hidden');

            if (tabName === 'ij') {
                contentIJ.classList.remove('hidden');
                contentIJ.classList.add('fade-in');
                contentJI.classList.add('hidden');
                contentJI.classList.remove('fade-in');
                
                btnIJ.className = "w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-active";
                btnJI.className = "w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-inactive";
            } else {
                contentJI.classList.remove('hidden');
                contentJI.classList.add('fade-in');
                contentIJ.classList.add('hidden');
                contentIJ.classList.remove('fade-in');
                
                btnJI.className = "w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-active";
                btnIJ.className = "w-1/2 py-2.5 rounded-lg text-xs md:text-sm font-bold transition-all flex items-center justify-center gap-2 tab-inactive";
            }
        }

        // --- DATA LOGIC ---
        function formatNumber(num) {
            if (num === "" || num === null || isNaN(num)) return 0;
            return parseFloat(num).toFixed(num % 1 === 0 ? 0 : 2);
        }

        function getUnit(type, index) {
            if (type === 'ij') {
                return (index === 0 || index === 1) ? 'KG' : 'PCS';
            } else {
                return (index === 0) ? 'KG' : 'PCS';
            }
        }

        function createGridCard(item, type, index) {
            const actual = parseFloat(item.actual) || 0;
            const shortage = parseFloat(item.shortage) || 0;
            const totalTarget = actual + shortage;
            
            let percentage = 0;
            if (totalTarget > 0) percentage = (actual / totalTarget) * 100;
            if (shortage <= 0 && actual > 0) percentage = 100;

            const unit = getUnit(type, index);
            
            let colorClass = 'bg-blue-500'; 
            let textClass = 'text-blue-600';
            
            if (percentage >= 100) {
                colorClass = 'bg-emerald-500';
                textClass = 'text-emerald-600';
            } else if (percentage < 30) {
                colorClass = 'bg-red-500';
                textClass = 'text-red-500';
            } else {
                colorClass = 'bg-amber-400';
                textClass = 'text-amber-600';
            }

            const icon = unit === 'KG' ? 'fa-weight-hanging' : 'fa-box-open';

            return `
            <div class="grid-card p-3 rounded-xl flex flex-col justify-between h-full relative overflow-hidden group">
                <div class="flex items-start justify-between gap-2 mb-2">
                    <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 shrink-0">
                        <i class="fa-solid ${icon} text-xs"></i>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${unit}</span>
                </div>
                
                <h3 class="font-bold text-slate-700 text-xs mb-2 line-clamp-2 leading-tight h-8">${item.name || 'No Name'}</h3>

                <div class="mt-auto">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xl font-bold ${textClass}">${formatNumber(actual)}</span>
                        <span class="text-[10px] text-slate-400 mb-1">/${formatNumber(totalTarget)}</span>
                    </div>

                    <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                        <div class="${colorClass} h-full rounded-full progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    
                    <div class="flex justify-between mt-1">
                        <span class="text-[9px] font-medium text-slate-400">${percentage.toFixed(0)}%</span>
                        ${shortage > 0 ? 
                            `<span class="text-[9px] text-red-400 font-medium">-${formatNumber(shortage)}</span>` : 
                            `<span class="text-[9px] text-emerald-500 font-bold"><i class="fa-solid fa-check"></i> OK</span>`
                        }
                    </div>
                </div>
            </div>`;
        }

        async function initDashboard() {
            const gridIJ = document.getElementById('grid-ij');
            const gridJI = document.getElementById('grid-ji');
            const updateLabel = document.getElementById('last-update');

            try {
                const response = await fetch(`${API_URL}?action=getData`);
                const json = await response.json();

                if (json.status === 'success') {
                    gridIJ.innerHTML = json.data.indoJepang
                        .map((item, index) => createGridCard(item, 'ij', index))
                        .join('');

                    gridJI.innerHTML = json.data.jepangIndo
                        .map((item, index) => createGridCard(item, 'ji', index))
                        .join('');
                    
                    const now = new Date();
                    updateLabel.innerHTML = `Updated: ${now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}`;
                } 
            } catch (error) {
                console.error(error);
                gridIJ.innerHTML = `<div class="col-span-full p-4 text-center text-red-400 text-xs">Gagal memuat data.</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
